name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

permissions:
  contents: read

jobs:
  build-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: ${{ github.event_name == 'release' && 'write' || 'read' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            name: Ubuntu 22.04
            triplet: x64-linux
            generator: Ninja
          - os: macos-14
            name: macOS 14 (arm64)
            triplet: arm64-osx
            generator: Ninja

    env:
      VCPKG_FEATURE_FLAGS: manifests,binarycaching
      VCPKG_BINARY_SOURCES: clear;x-gha,readwrite
      VCPKG_INSTALLED_DIR: ${{ github.workspace }}/vcpkg_installed
      VCPKG_TARGET_TRIPLET: ${{ matrix.triplet }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            autoconf \
            autoconf-archive \
            automake \
            libtool \
            libopenslide-dev \
            pkg-config \
            libx11-dev \
            libxext-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libgtk-3-dev

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install \
            cmake \
            ninja \
            openslide \
            pkg-config

      - name: Setup vcpkg (Linux/macOS)
        run: |
          git clone https://github.com/Microsoft/vcpkg.git "$GITHUB_WORKSPACE/vcpkg"
          "$GITHUB_WORKSPACE/vcpkg/bootstrap-vcpkg.sh"
          echo "VCPKG_ROOT=$GITHUB_WORKSPACE/vcpkg" >> "$GITHUB_ENV"

      - name: Configure CMake (Linux/macOS)
        run: |
          cmake -S . -B build -G "${{ matrix.generator }}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=$VCPKG_TARGET_TRIPLET \
            -DVCPKG_INSTALLED_DIR=$VCPKG_INSTALLED_DIR \
            -DBUILD_TESTING=ON

      - name: Build
        run: cmake --build build --target pathview pathview-mcp unit_tests --config Release --parallel

      - name: Run unit tests
        run: ctest --test-dir build --output-on-failure --timeout 120 -C Release
        continue-on-error: true

      - name: Read version
        if: github.event_name == 'release'
        id: version
        run: echo "version=$(cat VERSION)" >> "$GITHUB_OUTPUT"

      - name: Package artifacts
        if: github.event_name == 'release'
        run: |
          mkdir -p dist
          cp build/pathview dist/
          cp build/pathview-mcp dist/
          tar -czvf pathview-${{ steps.version.outputs.version }}-${{ matrix.triplet }}.tar.gz -C dist .

      - name: Upload release artifacts
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: pathview-${{ steps.version.outputs.version }}-${{ matrix.triplet }}.tar.gz
