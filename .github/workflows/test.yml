name: Test Suite

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-ubuntu:
    name: Ubuntu 22.04 Tests
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libopenslide-dev \
          libsdl2-dev \
          libsdl2-image-dev \
          protobuf-compiler \
          libprotobuf-dev \
          libabsl-dev \
          pkg-config

    - name: Install vcpkg
      run: |
        git clone https://github.com/Microsoft/vcpkg.git ~/vcpkg
        ~/vcpkg/bootstrap-vcpkg.sh
        echo "VCPKG_ROOT=$HOME/vcpkg" >> $GITHUB_ENV

    - name: Install vcpkg dependencies
      run: |
        export VCPKG_DEFAULT_TRIPLET=x64-linux
        ~/vcpkg/vcpkg install \
          sdl2 \
          sdl2-image \
          nativefiledialog-extended

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$HOME/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DBUILD_TESTING=ON

    - name: Build project
      run: cmake --build build -j$(nproc)

    - name: Run unit tests
      run: |
        chmod +x run_tests.sh
        ./run_tests.sh || echo "Some unit tests failed"

    - name: Run MCP integration tests
      run: |
        chmod +x run_mcp_tests.sh
        ./run_mcp_tests.sh || echo "Some MCP tests failed"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-ubuntu
        path: |
          build/test/*.xml
          build/*.log
        retention-days: 30

  test-macos:
    name: macOS 14 Tests (Apple Silicon)
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install Homebrew dependencies
      run: |
        brew install \
          cmake \
          ninja \
          openslide \
          protobuf \
          abseil \
          vcpkg \
          pkg-config

    - name: Set vcpkg triplet
      run: |
        echo "VCPKG_DEFAULT_TRIPLET=arm64-osx" >> $GITHUB_ENV
        echo "VCPKG_ROOT=$(brew --prefix vcpkg)" >> $GITHUB_ENV

    - name: Install vcpkg dependencies
      run: |
        vcpkg install \
          sdl2 \
          sdl2-image \
          nativefiledialog-extended

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=$(brew --prefix vcpkg)/scripts/buildsystems/vcpkg.cmake \
          -DBUILD_TESTING=ON

    - name: Build project
      run: cmake --build build -j$(sysctl -n hw.ncpu)

    - name: Run unit tests
      run: |
        chmod +x run_tests.sh
        ./run_tests.sh || echo "Some unit tests failed"

    - name: Run MCP integration tests
      run: |
        chmod +x run_mcp_tests.sh
        ./run_mcp_tests.sh || echo "Some MCP tests failed"

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-macos
        path: |
          build/test/*.xml
          build/*.log
        retention-days: 30

  test-pathanalyze:
    name: PathAnalyze (Python) Tests
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install PathAnalyze dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e "server/pathanalyze[dev]"

    - name: Run PathAnalyze tests
      run: |
        cd server/pathanalyze
        pytest || echo "Some PathAnalyze tests failed"

  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    needs: [test-ubuntu, test-macos, test-pathanalyze]
    if: always()

    steps:
    - name: Download all test results
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        merge-multiple: true

    - name: Generate test summary
      run: |
        echo "# Test Suite Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Status by Platform" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ needs.test-ubuntu.result }}" == "success" ]; then
          echo "✅ Ubuntu 22.04: Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ Ubuntu 22.04: Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.test-macos.result }}" == "success" ]; then
          echo "✅ macOS 14 (ARM64): Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ macOS 14 (ARM64): Failed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ needs.test-pathanalyze.result }}" == "success" ]; then
          echo "✅ PathAnalyze (Python): Passed" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ PathAnalyze (Python): Failed" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "Test results and logs are available in the artifacts section." >> $GITHUB_STEP_SUMMARY
